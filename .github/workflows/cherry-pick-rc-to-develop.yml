name: "Cherry-pick from rc to develop"

on:
    pull_request:
        branches:
            - release/candidate
        types:
            - closed

jobs:
    cherry-pick:
        runs-on: ubuntu-latest
        if: github.event.pull_request.merged == true

        steps:
            - name: Checkout
              uses: actions/checkout@v3
              with:
                  submodules: recursive # Needed in order to fetch Kalium sources for building
                  fetch-depth: 0

            - name: Extract branch name and remove prefix
              id: extract
              run: |
                PR_BRANCH="${{ github.event.pull_request.head.ref }}"
                NEW_BRANCH_NAME=$(echo $PR_BRANCH | sed 's|/rc-|/|')
                echo "New branch name: $NEW_BRANCH_NAME"
                echo "::set-output name=newBranchName::$NEW_BRANCH_NAME"

            - name: Cherry-pick commits
              run: |
                git fetch origin develop:develop
                git checkout -b ${{ steps.extract.outputs.newBranchName }} develop
                git checkout -b ${{ steps.extract.outputs.newBranchName }}-conflicts
                git config user.email "action@github.com"
                git config user.name "GitHub Action"
                COMMITS=$(git log --pretty=format:"%H" --reverse ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }})
                echo "Cherry-picking these commits: $COMMITS"
                for COMMIT in $COMMITS; do
                  git cherry-pick -x $COMMIT || true
                  if [ "$(git diff --check)" != "" ]; then
                    git add .
                    git commit -m "Conflicts from commit $COMMIT"
                  fi
                done
                git push origin ${{ steps.extract.outputs.newBranchName }}-conflicts
                git checkout ${{ steps.extract.outputs.newBranchName }}
                git cherry-pick ${{ steps.extract.outputs.newBranchName }}-conflicts^..${{ steps.extract.outputs.newBranchName }}-conflicts
                git push origin ${{ steps.extract.outputs.newBranchName }}
            

            - name: Create conflict PR
              uses: peter-evans/create-pull-request@v5
              with:
                title: Handle conflicts from cherry-pick
                base: ${{ steps.extract.outputs.newBranchName }}
                branch: "${{ steps.extract.outputs.newBranchName }}-conflicts"
                body: Conflicts from cherry-pick

            - name: Create PR
              uses: peter-evans/create-pull-request@v5
              with:
                title: ${{ github.event.pull_request.title }}
                base: develop
                branch: "${{ steps.extract.outputs.newBranchName }}"
                body: ${{ github.event.pull_request.body }}
